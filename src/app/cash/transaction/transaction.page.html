<app-header-bar></app-header-bar>
<app-divider></app-divider>

<ion-content>
    <app-container>
        <div class="page-title">여민전</div>

        <!-- 잔액 카드: 새로고침 버튼 우상단 고정, 잔액은 크게 -->
        <section class="wallet" *ngIf="summary">
            <div class="refresh-btn">
                <app-button label="새로고침" variant="bordered-gray" size="fit" type="button" aria-label="캐쉬 새로고침"
                    (click)="fetchAll()">
                </app-button>
            </div>

            <div class="wallet-top">
                <div class="label">현재 잔액</div>
                <div class="balance">
                    {{ krw(displayBalance) }}
                </div>
            </div>
        </section>

        <!-- 필터/검색 -->
        <section class="toolbar">
            <div class="chips">
                <app-button label="전체" [variant]="filter==='ALL' ? 'tinted-bordered' : 'bordered-gray'" size="fit"
                    type="button" (click)="setFilter('ALL')">
                </app-button>

                <app-button label="충전"
                    [variant]="filter===CashTransactionType.DEPOSIT ? 'tinted-bordered' : 'bordered-gray'" size="fit"
                    type="button" (click)="setFilter(CashTransactionType.DEPOSIT)">
                </app-button>

                <app-button label="사용"
                    [variant]="filter===CashTransactionType.PAYMENT ? 'tinted-bordered' : 'bordered-gray'" size="fit"
                    type="button" (click)="setFilter(CashTransactionType.PAYMENT)">
                </app-button>

                <app-button label="인출"
                    [variant]="filter===CashTransactionType.WITHDRAW ? 'tinted-bordered' : 'bordered-gray'" size="fit"
                    type="button" (click)="setFilter(CashTransactionType.WITHDRAW)">
                </app-button>
            </div>

            <div class="search">
                <app-input [placeholder]="'상호/사유 검색'" [(value)]="q" (valueChange)="onSearchChange()">
                </app-input>
            </div>
        </section>

        <!-- 에러 -->
        <div class="inline-error" *ngIf="error">{{ error }}</div>

        <!-- 거래 내역 -->
        <section class="groups" *ngIf="!loading">
            <ng-container *ngFor="let g of groups">
                <div class="date-sep">{{ g.dateLabel }}</div>

                <!-- 포인트 페이지 패턴 동일 적용 -->
                <div class="tx" *ngFor="let t of g.items; trackBy: trackByTx"
                    [class.deposit]="t.type===CashTransactionType.DEPOSIT"
                    [class.withdraw]="t.type===CashTransactionType.WITHDRAW"
                    [class.payment]="t.type===CashTransactionType.PAYMENT">

                    <div class="leftbar"></div>

                    <div class="tx-main">
                        <div class="title">{{ t.reason }}</div>
                        <div class="meta">
                            <span class="pill" [class.deposit]="t.type===CashTransactionType.DEPOSIT"
                                [class.withdraw]="t.type===CashTransactionType.WITHDRAW"
                                [class.payment]="t.type===CashTransactionType.PAYMENT">
                                {{ t.type == CashTransactionType.PAYMENT ? '사용' : t.type == CashTransactionType.DEPOSIT
                                ? '충전' : '인출' }}
                            </span>
                            <span class="time">{{ timeHHMM(t.created_at) }}</span>
                        </div>
                    </div>

                    <!-- 금액 + 러닝 잔액 -->
                    <div class="tx-amount" [class.plus]="t.type===CashTransactionType.DEPOSIT"
                        [class.minus]="t.type!==CashTransactionType.DEPOSIT">
                        {{ signByType(t.type) }}{{ krw(t.amount) }}
                        <div class="running">잔액 {{ krw(t.runningBalance ?? 0) }}</div>
                    </div>
                </div>
            </ng-container>

            <div class="empty" *ngIf="groups.length === 0">
                조건에 맞는 내역이 없습니다.
            </div>
        </section>
    </app-container>
</ion-content>